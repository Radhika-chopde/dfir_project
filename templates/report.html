<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFIR Live Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">

    <nav class="bg-white p-4 shadow-md sticky top-0 z-10 border-b border-gray-200">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-purple-600">Live Investigation Report</h1>
                <p class="text-gray-600 text-sm">ID: <span id="investigation-id">{{ investigation_id }}</span></p>
            </div>
            <div class="flex space-x-4">
                <a href="/raw_log" target="_blank" 
                   class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg transition">
                    View Raw Log
                </a>
                <a href="/" 
                   class="text-sm bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg transition font-medium">
                    New Analysis
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-gray-600 text-sm font-medium">Total Artifacts</h3>
                <p id="stat-total" class="text-3xl font-bold text-gray-900">0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-gray-600 text-sm font-medium">High Suspicion</h3>
                <p id="stat-high" class="text-3xl font-bold text-yellow-500">0</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200">
                <h3 class="text-gray-600 text-sm font-medium">Known Malware</h3>
                <p id="stat-malware" class="text-3xl font-bold text-red-600">0</p>
            </div>
        </div>

        <div id="report-container" class="space-y-6">
            <p id="loading-message" class="text-center text-gray-600 text-lg">Loading report...</p>
        </div>
    </div>

    <script>
        const reportContainer = document.getElementById('report-container');
        const loadingMessage = document.getElementById('loading-message');
        const statTotal = document.getElementById('stat-total');
        const statHigh = document.getElementById('stat-high');
        const statMalware = document.getElementById('stat-malware');

        function getBorderColor(score, knownBad) {
            if (knownBad) return 'border-red-500';
            if (score >= 5) return 'border-yellow-400';
            if (score > 0) return 'border-purple-500';
            return 'border-gray-200';
        }

        function getTag(score, knownBad) {
            if (knownBad) {
                return `<span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full">KNOWN MALWARE</span>`;
            }
            if (score >= 5) {
                return `<span class="bg-yellow-400 text-gray-900 text-xs font-bold px-3 py-1 rounded-full">HIGH SUSPICION</span>`;
            }
            if (score > 0) {
                return `<span class="bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full">SUSPICIOUS</span>`;
            }
            return `<span class="bg-gray-500 text-white text-xs font-bold px-3 py-1 rounded-full">INFO</span>`;
        }

        function createArtifactCard(artifact) {
            const { file_path, findings, score, hash, known_bad } = artifact;
            const borderColor = getBorderColor(score, known_bad);
            const tag = getTag(score, known_bad);

            let findingsHTML = findings.map(f => 
                `<li class="font-mono text-xs text-gray-600 break-words">${f}</li>`
            ).join('');

            return `
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border-t-4 ${borderColor} border border-gray-200">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <h2 class="text-lg font-semibold text-gray-900 break-all" title="${file_path}">
                                ${file_path}
                            </h2>
                            <div class="flex-shrink-0 ml-4 space-x-2">
                                ${tag}
                                <span class="bg-gray-200 text-gray-800 text-xs font-bold px-3 py-1 rounded-full">SCORE: ${score}</span>
                            </div>
                        </div>
                        
                        ${hash ? `<p class="text-sm font-mono text-purple-600 mb-4 break-all"><b>SHA256:</b> ${hash}</p>` : ''}
                        
                        <div class="bg-gray-50 border border-gray-200 p-4 rounded-lg">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Correlated Findings (${findings.length}):</h4>
                            <ul class="list-disc list-inside space-y-2 pl-2">
                                ${findingsHTML}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        async function fetchReport() {
            try {
                const response = await fetch('/api/report/latest');
                if (!response.ok) {
                    throw new Error('Failed to load report data.');
                }
                const data = await response.json();
                
                document.getElementById('investigation-id').innerText = data.investigation_id || 'N/A';
                
                const artifacts = data.artifacts || [];
                
                if (artifacts.length > 0) {
                    loadingMessage.style.display = 'none';
                    reportContainer.innerHTML = ''; 
                    
                    let highCount = 0;
                    let malwareCount = 0;

                    artifacts.forEach(artifact => {
                        if (artifact.known_bad) malwareCount++;
                        else if (artifact.score >= 5) highCount++;

                        reportContainer.innerHTML += createArtifactCard(artifact);
                    });

                    statTotal.innerText = artifacts.length;
                    statHigh.innerText = highCount;
                    statMalware.innerText = malwareCount;

                } else {
                    loadingMessage.innerText = 'Analysis is running... Waiting for findings...';
                }

            } catch (error) {
                console.error(error);
                loadingMessage.innerText = 'Error loading report. Check console.';
                loadingMessage.className = 'text-center text-red-600 text-lg';
            }
        }

        fetchReport();
        
        setInterval(fetchReport, 5000);

    </script>
</body>
</html>